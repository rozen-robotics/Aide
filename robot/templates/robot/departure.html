{% extends 'portal_base.html' %}
{% load static %}

{% block title %}
    <h3 class="text-center mb-0 text-white">{{ cruise.departure_station }} - {{ cruise.arrival_station }}
        - {{ cruise.train_number }}</h3>
{% endblock %}

{% block content %}
    <div class="container mt-5">
        <div class="card shadow-lg">
            <div class="card-body">
                {% csrf_token %}
                <!-- Видеопоток с камеры -->
                <div class="mb-3" id="video-container">
                    <div class="video-container text-center mb-3">
                        <canvas id="video-canvas" class="border rounded"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/animate-css/animate.css' %}"/>
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/sweetalert2/sweetalert2.css' %}"/>
    <style>
        .video-container {
            position: relative;
            width: 100%;
            height: 600px;
            overflow: hidden;
        }

        #video-canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
{% endblock %}

{% block js %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const videoCanvas = document.getElementById('video-canvas');
            let stream;
            let recognitionInProgress = false;

            navigator.mediaDevices.getUserMedia({video: true})
                .then(cameraStream => {
                    stream = cameraStream;
                    const context = videoCanvas.getContext('2d');
                    videoCanvas.width = 640;
                    videoCanvas.height = 480;
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();

                    function drawFrame() {
                        context.drawImage(video, 0, 0, videoCanvas.width, videoCanvas.height);
                        requestAnimationFrame(drawFrame);
                    }

                    drawFrame();

                    // Начать распознавание с интервалом 0.1 секунда
                    setInterval(takeAndSendPhoto, 100);
                })
                .catch(error => {
                    console.error("Ошибка при доступе к камере:", error);
                });

            function takeAndSendPhoto() {
                if (recognitionInProgress) return;

                recognitionInProgress = true;

                const context = videoCanvas.getContext('2d');
                const imageDataURL = videoCanvas.toDataURL('image/png');

                fetch('{% url 'recognize_face_ajax' %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `photo_data=${encodeURIComponent(imageDataURL)}&cruise_id={{ cruise.id }}`,
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            return showSweetAlert('success', 'Авторизация прошла успешно', `Здравствуйте, ${data.data.first_name} ${data.data.last_name}! Ваше место ${data.data.seat_number}, хорошей поездки!`, 4000);
                        } else if (data.status === 'not_registered') {
                            return showSweetAlert('error', 'Вас нет в списке быстрого прохода!', 'Подойдите к проводнику для входа в поезд.', 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка при распознавании лица:', error);
                        return showSweetAlert('error', 'Ошибка!', 'Произошла ошибка, попробуйте снова.', 2000);
                    })
                    .finally(() => {
                        // Задержка перед продолжением работы
                        setTimeout(() => {
                            recognitionInProgress = false;
                        }, 1000); // Задержка после показа алерта перед продолжением
                    });
            }

            function showSweetAlert(icon, title, text, time) {
                return Swal.fire({
                    icon: icon,
                    title: title,
                    text: text,
                    showConfirmButton: false,
                    timer: time // Продолжительность отображения алерта
                });
            }
        });
    </script>
    <script src="{% static 'assets/vendor/libs/sweetalert2/sweetalert2.js' %}"></script>
{% endblock %}
